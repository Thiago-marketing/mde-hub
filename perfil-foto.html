<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MDE Hub â€¢ Foto de Perfil</title>

  <link rel="stylesheet" href="/css/app.css" />
</head>

<body>

<!-- BOTÃƒO MOBILE -->
<div id="btnSidebarToggle">â˜°</div>

<!-- SIDEBAR VIA PARTIAL -->
<div id="sidebar-container"></div>

<!-- MAIN AREA OFICIAL -->
<main class="main-area">

  <!-- TOPBAR PREMIUM OFICIAL -->
  <header class="topbar">
    <div class="topbar-left">
      <h1 class="page-title">Foto de Perfil</h1>
      <p class="page-subtitle">Atualize sua imagem de usuÃ¡rio no Hub MDE</p>
    </div>

    <div class="topbar-right">
      <div class="hotel-select-wrapper">
        <span class="label">Hotel</span>
        <select id="hotelSelector">
          <option>Carregando...</option>
        </select>
      </div>

      <button id="btnThemeToggle" class="theme-toggle">ðŸŒ“</button>

      <div class="user-pill">
        <div class="user-avatar">H</div>
        <div class="user-info">
          <span class="user-name">Hotel Exemplo</span>
          <span class="user-email">contato@hotelexemplo.com</span>
        </div>
      </div>
    </div>
  </header>

  <!-- CONTEÃšDO -->
  <section class="card">
    <div class="card-title">Avatar</div>
    <p class="card-desc">Envie uma foto PNG ou JPG com atÃ© 2MB.</p>

    <div class="avatar-wrapper">

      <div class="avatar-preview" id="avatarPreview">
        <span id="avatarInitialBig">U</span>
      </div>

      <p class="avatar-hint">
        Esta foto serÃ¡ exibida no topo e em telas do CRM/Painel.
      </p>

      <input type="file" id="fileInput" class="file-input" accept="image/*" />

      <div class="btn-row">
        <button class="btn-outline" id="btnChoose">Escolher imagem</button>
        <button class="btn-primary" id="btnUpload" disabled>Salvar foto</button>
      </div>

      <div id="statusMsg" class="status-msg"></div>
    </div>

  </section>

</main>

<!-- SCRIPTS GLOBAIS -->
<script type="module" src="/js/supabase.js"></script>
<script type="module" src="/js/app.js"></script>

<!-- IMPORTAR SIDEBAR -->
<script>
  fetch("/partials/sidebar.html")
    .then(r => r.text())
    .then(html => (document.getElementById("sidebar-container").innerHTML = html));
</script>

<!-- SCRIPT DO AVATAR -->
<script type="module">
  import { supabase } from "/js/supabase.js";

  const avatarPreview = document.getElementById("avatarPreview");
  const avatarInitialBig = document.getElementById("avatarInitialBig");
  const fileInput = document.getElementById("fileInput");
  const btnChoose = document.getElementById("btnChoose");
  const btnUpload = document.getElementById("btnUpload");
  const statusMsg = document.getElementById("statusMsg");

  let selectedFile = null;
  let currentUser = null;

  // Carrega o avatar atual
  async function loadUserAvatar() {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (!user) return;

    currentUser = user;
    const initial = (user.email || "U").charAt(0).toUpperCase();
    avatarInitialBig.textContent = initial;

    const { data: profile } = await supabase
      .from("profiles")
      .select("avatar_url, full_name")
      .eq("id", user.id)
      .single();

    if (profile?.avatar_url)
      setPreviewImage(profile.avatar_url);
    else if (profile?.full_name)
      avatarInitialBig.textContent = profile.full_name.charAt(0).toUpperCase();
  }

  function setPreviewImage(url) {
    avatarPreview.innerHTML = "";
    const img = document.createElement("img");
    img.src = url;
    avatarPreview.appendChild(img);
  }

  btnChoose.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (!file) return;

    if (file.size > 2 * 1024 * 1024) {
      statusMsg.textContent = "Arquivo maior que 2MB.";
      statusMsg.className = "status-msg status-err";
      return;
    }

    selectedFile = file;
    const reader = new FileReader();
    reader.onload = e => {
      avatarPreview.innerHTML = "";
      const img = document.createElement("img");
      img.src = e.target.result;
      avatarPreview.appendChild(img);
    };
    reader.readAsDataURL(file);

    btnUpload.disabled = false;
    statusMsg.textContent = "PrÃ©-visualizaÃ§Ã£o carregada.";
  });

  btnUpload.addEventListener("click", async () => {

    const fileExt = selectedFile.name.split(".").pop();
    const fileName = `user-${currentUser.id}-${Date.now()}.${fileExt}`;

    statusMsg.textContent = "Enviando imagem...";

    const { error: uploadError } = await supabase.storage
      .from("avatars")
      .upload(fileName, selectedFile, { cacheControl: "3600", upsert: true });

    if (uploadError) {
      statusMsg.textContent = "Erro ao enviar.";
      statusMsg.className = "status-msg status-err";
      return;
    }

    const { data: urlData } = supabase.storage
      .from("avatars")
      .getPublicUrl(fileName);

    const publicUrl = urlData.publicUrl;

    const { error: profileErr } = await supabase
      .from("profiles")
      .update({ avatar_url: publicUrl })
      .eq("id", currentUser.id);

    if (profileErr) {
      statusMsg.textContent = "Erro ao salvar no perfil.";
      statusMsg.className = "status-msg status-err";
      return;
    }

    statusMsg.textContent = "Foto atualizada com sucesso!";
    statusMsg.className = "status-msg status-ok";
    btnUpload.disabled = true;
  });

  loadUserAvatar();
</script>

</body>
</html>
