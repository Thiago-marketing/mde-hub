<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MDE Hub â€¢ CRM Dashboard</title>

  <link rel="stylesheet" href="/css/app.css" />
</head>

<body>

<!-- BOTÃƒO DO MENU MOBILE -->
<div id="btnSidebarToggle">â˜°</div>

<!-- SIDEBAR DINÃ‚MICA -->
<div id="sidebar-container"></div>

<!-- ÃREA PRINCIPAL -->
<main class="main-area">

  <!-- HEADER -->
  <header class="page-header">
    <div>
      <h1 class="page-title">ðŸ“Š Dashboard do CRM</h1>
      <p class="page-subtitle">Indicadores de performance comercial do hotel</p>
    </div>

    <div class="topbar-right">
      <select id="hotelSelect"></select>
      <button id="btnThemeToggle">ðŸŒ“</button>
      <div class="user-badge" id="userMini">U</div>
    </div>
  </header>

  <!-- GRID DE INDICADORES -->
  <section class="grid">

    <div class="card">
      <div class="card-title">Leads no mÃªs</div>
      <div class="card-value" id="crm_leads_mes">--</div>
      <div class="card-desc">Total capturado no CRM</div>
    </div>

    <div class="card">
      <div class="card-title">Taxa de ConversÃ£o</div>
      <div class="card-value" id="crm_conversao">--%</div>
      <div class="card-desc">Leads que viraram reservas</div>
    </div>

    <div class="card">
      <div class="card-title">Propostas enviadas</div>
      <div class="card-value" id="crm_propostas_enviadas">--</div>
      <div class="card-desc">Total no perÃ­odo</div>
    </div>

    <div class="card">
      <div class="card-title">Propostas aceitas</div>
      <div class="card-value" id="crm_propostas_aceitas">--</div>
      <div class="card-desc">ConversÃµes efetivas</div>
    </div>

  </section>

  <!-- GRÃFICOS -->
  <section class="grid">

    <div class="card">
      <div class="card-title">Leads por Etapa</div>
      <div id="graf_leads_etapas" class="chart-placeholder">GrÃ¡fico aquiâ€¦</div>
    </div>

    <div class="card">
      <div class="card-title">Propostas por Status</div>
      <div id="graf_propostas" class="chart-placeholder">GrÃ¡fico aquiâ€¦</div>
    </div>

  </section>

  <!-- ATIVIDADES RECENTES -->
  <section class="card">
    <div class="card-title">Atividades Recentes</div>

    <table class="table">
      <thead>
        <tr>
          <th>Lead</th>
          <th>AÃ§Ã£o</th>
          <th>DescriÃ§Ã£o</th>
          <th>Quando</th>
        </tr>
      </thead>

      <tbody id="crm_atividades_list">
        <tr><td colspan="4">Carregando atividades...</td></tr>
      </tbody>
    </table>
  </section>

</main>

<!-- JS -->
<script type="module">
  import { supabase } from "/js/supabase.js";

  async function carregarDashboardCRM() {
    const hotelId = sessionStorage.getItem("hotel_id");

    // LEADS DO MÃŠS
    const { data: leadsMes } = await supabase
      .from("leads")
      .select("id")
      .eq("hotel_id", hotelId)
      .gte("created_at", new Date().toISOString().slice(0, 7) + "-01");

    document.getElementById("crm_leads_mes").innerText = leadsMes?.length ?? 0;

    // TAXA DE CONVERSÃƒO
    const { data: ganhos } = await supabase
      .from("leads")
      .select("id")
      .eq("hotel_id", hotelId)
      .eq("etapa", "ganho");

    const conversao = leadsMes?.length
      ? Math.round((ganhos.length / leadsMes.length) * 100)
      : 0;

    document.getElementById("crm_conversao").innerText = conversao + "%";

    // PROPOSTAS ENVIADAS
    const { data: propostas } = await supabase
      .from("propostas")
      .select("id, status")
      .eq("hotel_id", hotelId);

    document.getElementById("crm_propostas_enviadas").innerText =
      propostas?.length ?? 0;

    // PROPOSTAS ACEITAS
    const aceitas = propostas?.filter(p => p.status === "aceita").length ?? 0;
    document.getElementById("crm_propostas_aceitas").innerText = aceitas;

    // ATIVIDADES RECENTES
    const { data: atividades } = await supabase
      .from("atividades")
      .select("*, leads(nome)")
      .eq("hotel_id", hotelId)
      .order("created_at", { ascending: false })
      .limit(20);

    const tbody = document.getElementById("crm_atividades_list");
    tbody.innerHTML = "";

    atividades?.forEach(a => {
      tbody.innerHTML += `
        <tr>
          <td>${a.leads?.nome ?? "--"}</td>
          <td>${a.tipo}</td>
          <td>${a.descricao}</td>
          <td>${new Date(a.created_at).toLocaleString("pt-BR")}</td>
        </tr>
      `;
    });
  }

  carregarDashboardCRM();
</script>

<!-- IMPORTAÃ‡ÃƒO SIDEBAR -->
<script>
  fetch("/partials/sidebar.html")
    .then(r => r.text())
    .then(html => {
      document.querySelector("#sidebar-container").innerHTML = html;
    });
</script>

</body>
</html>
