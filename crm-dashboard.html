<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM Hoteleiro â€¢ Dashboard</title>

  <link rel="stylesheet" href="/css/app.css" />
</head>

<body class="page">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-mark">M</span>
      <span class="logo-text">Web MDE</span>
    </div>

    <nav class="menu">

      <div class="menu-section">
        <p class="menu-title">CRM</p>
        <a href="/crm-dashboard.html" class="active strong">ğŸ“Š Dashboard</a>
        <a href="/crm-kanban.html">ğŸ—‚ Funil Kanban</a>
        <a href="/crm.html">ğŸ“ Leads</a>
        <a href="/crm-propostas.html">ğŸ“„ Propostas</a>
        <a href="/crm-atividades.html">ğŸ“ Atividades</a>
        <a href="/crm-contatos.html">ğŸ‘¥ Contatos</a>
      </div>

      <div class="menu-section">
        <p class="menu-title">Ferramentas</p>
        <a href="/simuladores.html">ğŸ§® Simuladores</a>
      </div>

      <div class="menu-section">
        <p class="menu-title">Sistema</p>
        <a href="/crm-config.html">âš™ï¸ ConfiguraÃ§Ãµes</a>
        <a href="/logout.html" class="logout">ğŸšª Sair</a>
      </div>

    </nav>
  </aside>

  <!-- MAIN AREA -->
  <main class="main-area">

    <!-- TOPBAR -->
    <header class="topbar">
      <button id="btnSidebar" class="btn-icon">â˜°</button>

      <div class="topbar-title">
        <h1>Dashboard do CRM</h1>
        <p>Indicadores de performance comercial do hotel</p>
      </div>

      <div class="topbar-actions">
        <select id="hotelSelect"></select>
        <button id="btnThemeToggle" class="btn-icon">ğŸŒ“</button>
        <div class="user-mini"><span id="userMini">U</span></div>
      </div>
    </header>

    <!-- DASHBOARD GRID -->
    <section class="grid">

      <div class="card">
        <div class="card-title">Leads no mÃªs</div>
        <div class="card-value" id="crm_leads_mes">--</div>
        <p class="card-desc">Total capturado no CRM</p>
      </div>

      <div class="card">
        <div class="card-title">Taxa de ConversÃ£o</div>
        <div class="card-value" id="crm_conversao">--%</div>
        <p class="card-desc">Leads que viraram reservas</p>
      </div>

      <div class="card">
        <div class="card-title">Propostas enviadas</div>
        <div class="card-value" id="crm_propostas_enviadas">--</div>
        <p class="card-desc">Total no perÃ­odo</p>
      </div>

      <div class="card">
        <div class="card-title">Propostas aceitas</div>
        <div class="card-value" id="crm_propostas_aceitas">--</div>
        <p class="card-desc">ConversÃµes efetivas</p>
      </div>

    </section>

    <!-- GRÃFICOS -->
    <section class="grid">

      <div class="card">
        <div class="card-title">Leads por Etapa</div>
        <div id="graf_leads_etapas" class="chart-placeholder">GrÃ¡fico aqui...</div>
      </div>

      <div class="card">
        <div class="card-title">Propostas por Status</div>
        <div id="graf_propostas" class="chart-placeholder">GrÃ¡fico aqui...</div>
      </div>

    </section>

    <!-- LISTA DE ATIVIDADES RECENTES -->
    <section class="card">
      <div class="card-title">Atividades Recentes</div>
      <table class="table">
        <thead>
          <tr>
            <th>Lead</th>
            <th>AÃ§Ã£o</th>
            <th>DescriÃ§Ã£o</th>
            <th>Quando</th>
          </tr>
        </thead>
        <tbody id="crm_atividades_list">
          <tr><td colspan="4">Carregando atividades...</td></tr>
        </tbody>
      </table>
    </section>

  </main>

  <!-- JS -->
  <script type="module">
    import { supabase } from "/js/supabase.js";
    import {
      carregarPropostasLead,
      carregarMapaPropostasPorLead
    } from "/js/crm.js";

    async function carregarDashboardCRM() {
      const hotelId = sessionStorage.getItem("hotel_id");

      // Carrega leads do mÃªs
      const { data: leadsMes } = await supabase
        .from("leads")
        .select("id")
        .eq("hotel_id", hotelId)
        .gte("created_at", new Date().toISOString().slice(0, 7) + "-01");

      document.getElementById("crm_leads_mes").innerText = leadsMes?.length ?? 0;

      // Taxa de conversÃ£o
      const { data: ganhos } = await supabase
        .from("leads")
        .select("id")
        .eq("hotel_id", hotelId)
        .eq("etapa", "ganho");

      const conversao = leadsMes?.length
        ? Math.round((ganhos.length / leadsMes.length) * 100)
        : 0;

      document.getElementById("crm_conversao").innerText = conversao + "%";

      // Propostas enviadas
      const { data: propostas } = await supabase
        .from("propostas")
        .select("id, status")
        .eq("hotel_id", hotelId);

      document.getElementById("crm_propostas_enviadas").innerText = propostas?.length ?? 0;

      // Propostas aceitas
      const aceitas = propostas?.filter(p => p.status === "aceita").length ?? 0;
      document.getElementById("crm_propostas_aceitas").innerText = aceitas;

      // Atividades recentes
      const { data: atividades } = await supabase
        .from("atividades")
        .select("*, leads(nome)")
        .eq("hotel_id", hotelId)
        .order("created_at", { ascending: false })
        .limit(20);

      const tbody = document.getElementById("crm_atividades_list");
      tbody.innerHTML = "";

      atividades?.forEach(a => {
        tbody.innerHTML += `
          <tr>
            <td>${a.leads?.nome ?? "--"}</td>
            <td>${a.tipo}</td>
            <td>${a.descricao}</td>
            <td>${new Date(a.created_at).toLocaleString("pt-BR")}</td>
          </tr>
        `;
      });
    }

    carregarDashboardCRM();
  </script>

</body>
</html>
