// /js/app.js
// MDE Hub • Layout + Tema + Navegação + Simuladores
// (versão premium inicial, sem dependência direta do Supabase ainda)

document.addEventListener("DOMContentLoaded", () => {
  initTheme();
  initSidebarActive();
  initUserBadge();
  initHotelPlaceholder();
  initSimulators();
});

/* -----------------------------------------------------------
   TEMA (DARK / CLEAN)
----------------------------------------------------------- */
function initTheme() {
  const html = document.documentElement;
  const stored = localStorage.getItem("mdehub-theme");
  const prefersDark = window.matchMedia &&
    window.matchMedia("(prefers-color-scheme: dark)").matches;

  let current = stored || (prefersDark ? "dark" : "clean");
  html.setAttribute("data-theme", current);

  const btn = document.getElementById("themeToggle");
  if (!btn) return;

  updateThemeButtonLabel(btn, current);

  btn.addEventListener("click", () => {
    current = current === "dark" ? "clean" : "dark";
    html.setAttribute("data-theme", current);
    localStorage.setItem("mdehub-theme", current);
    updateThemeButtonLabel(btn, current);
  });
}

function updateThemeButtonLabel(btn, theme) {
  btn.textContent = theme === "dark" ? "Modo claro" : "Modo escuro";
}

/* -----------------------------------------------------------
   SIDEBAR – MARCAR ITEM ATIVO
----------------------------------------------------------- */
function initSidebarActive() {
  const path = window.location.pathname.split("/").pop() || "dashboard.html";
  const links = document.querySelectorAll(".nav-item");

  links.forEach(link => {
    const href = link.getAttribute("href");
    if (!href) return;

    const base = href.split("/").pop();
    if (base === path) {
      link.classList.add("active");
    } else {
      link.classList.remove("active");
    }
  });
}

/* -----------------------------------------------------------
   USER BADGE (INICIAL) – PLACEHOLDER
   Futuro: puxar nome real via Supabase.
----------------------------------------------------------- */
function initUserBadge() {
  const badge = document.getElementById("userInitial");
  if (!badge) return;

  // Placeholder: tenta pegar de localStorage ou usa "U"
  const storedName = localStorage.getItem("mdehub-user-name") || "Usuário";
  const initial = storedName.trim().charAt(0).toUpperCase() || "U";

  badge.textContent = initial;

  const nameSpan = document.getElementById("userName");
  if (nameSpan) {
    nameSpan.textContent = storedName;
  }
}

/* -----------------------------------------------------------
   HOTEL SELECT – APENAS PLACEHOLDER VISUAL
   Futuro: popular a partir do banco.
----------------------------------------------------------- */
function initHotelPlaceholder() {
  const select = document.getElementById("hotelSelect");
  if (!select) return;

  // Evita duplicar opções se já estiver preenchido por outro script
  if (select.options.length > 0) return;

  const opt = document.createElement("option");
  opt.value = "demo";
  opt.textContent = "Carregando hotéis...";
  select.appendChild(opt);
}

/* -----------------------------------------------------------
   SIMULADORES – ADR / DIÁRIAS / OCUPAÇÃO / REVPAR
----------------------------------------------------------- */
function initSimulators() {
  initSimuladorADR();
  initSimuladorDiarias();
  initSimuladorOcupacao();
  initSimuladorRevpar();
}

/* --------- ADR --------- */
function initSimuladorADR() {
  const form = document.getElementById("formADR");
  if (!form) return;

  const inputReceita = document.getElementById("adrReceita");
  const inputDiariasVendidas = document.getElementById("adrDiarias");
  const selectPeriodo = document.getElementById("adrPeriodo");
  const output = document.getElementById("adrResultado");

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const receita = parseFloat((inputReceita.value || "0").replace(",", "."));
    const diariasVendidas = parseFloat((inputDiariasVendidas.value || "0").replace(",", "."));

    if (!receita || !diariasVendidas || diariasVendidas <= 0) {
      output.textContent = "–";
      return;
    }

    const adr = receita / diariasVendidas;
    output.textContent = "R$ " + adr.toFixed(2).replace(".", ",");
  });
}

/* --------- DIÁRIAS NECESSÁRIAS --------- */
function initSimuladorDiarias() {
  const form = document.getElementById("formDiarias");
  if (!form) return;

  const inputMeta = document.getElementById("metaFaturamento");
  const inputAdrEstimada = document.getElementById("adrEstimada");
  const output = document.getElementById("diariasResultado");

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const meta = parseFloat((inputMeta.value || "0").replace(",", "."));
    const adr = parseFloat((inputAdrEstimada.value || "0").replace(",", "."));

    if (!meta || !adr || adr <= 0) {
      output.textContent = "– diárias";
      return;
    }

    const diarias = meta / adr;
    output.textContent = diarias.toFixed(1).replace(".", ",") + " diárias";
  });
}

/* --------- OCUPAÇÃO --------- */
function initSimuladorOcupacao() {
  const form = document.getElementById("formOcupacao");
  if (!form) return;

  const inputUhs = document.getElementById("ocupUhs");
  const inputDias = document.getElementById("ocupDias");
  const inputVendidas = document.getElementById("ocupVendidas");
  const output = document.getElementById("ocupResultado");

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const uhs = parseFloat((inputUhs.value || "0").replace(",", "."));
    const dias = parseFloat((inputDias.value || "0").replace(",", "."));
    const vendidas = parseFloat((inputVendidas.value || "0").replace(",", "."));

    const capacidade = uhs * dias;

    if (!uhs || !dias || !vendidas || capacidade <= 0) {
      output.textContent = "--%";
      return;
    }

    const ocup = (vendidas / capacidade) * 100;
    output.textContent = ocup.toFixed(1).replace(".", ",") + "%";
  });
}

/* --------- REVPAR --------- */
function initSimuladorRevpar() {
  const form = document.getElementById("formRevpar");
  if (!form) return;

  const inputReceita = document.getElementById("revReceita");
  const inputUhs = document.getElementById("revUhs");
  const inputDias = document.getElementById("revDias");
  const output = document.getElementById("revResultado");

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const receita = parseFloat((inputReceita.value || "0").replace(",", "."));
    const uhs = parseFloat((inputUhs.value || "0").replace(",", "."));
    const dias = parseFloat((inputDias.value || "0").replace(",", "."));

    const base = uhs * dias;

    if (!receita || !uhs || !dias || base <= 0) {
      output.textContent = "R$ --";
      return;
    }

    const revpar = receita / base;
    output.textContent = "R$ " + revpar.toFixed(2).replace(".", ",");
  });
}
